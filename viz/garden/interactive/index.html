<head>
  <style> 
    body{ margin: 0; }
    #info{
      width: 100%;
      position: fixed;
      top: 0;
      color: black;
      display: flex;
      justify-content: space-between;
      z-index: 1;
      padding: 1rem;
      box-sizing: border-box;
      font-family: sans-serif;
    }
    #garden{
        position: fixed;
        width: 10px; height: 10px;
        margin-left: -5px; margin-top: -5px;
        background-color: red;
        border-radius: 1000px;
        transform: translate(50%, 50%);
        z-index: 2;
    }

     #garden-overlay{
        position: absolute;
        width: 300px; height: 300px;
        border-radius: 1000px;
        position: absolute;
        top: 50%; right: 50%;
        transform: translate(50%,-50%);
        background: green;
        color: white;
        z-index: 2;
        transition: opacity 5s ease;
        opacity: 1;

    }
    #garden-overlay.dim{
      opacity: 0;
    }

    .dot{
        position: absolute;
        width: 10px; height: 10px;
        background-color: red;
        /* border-radius: 1000px; */
        /* top: 50%; right: 50%; */
        /* transform: translate(50%,-50%); */
        z-index: 2;
    }
  </style>

  <script src="//unpkg.com/force-graph"></script>
  <!--<script src="../../dist/force-graph.js"></script>-->
</head>

<body>
  <div id="info">
      <form class="pure-form" onsubmit="inputChange(event)">
          <input id="num" type="text" placeholder="Node Number" />
          <button type="submit">Nav to node</button>
      </form>
      <form class="pure-form" onsubmit="makeLink(event)">
          <input id="link" type="text" placeholder="Node Number" />
          <button type="submit">Make link to</button>
      </form>

      <form class="pure-form" onsubmit="makeNode(event)">
        <!-- <input id="link" type="text" placeholder="Node Number" /> -->
        <button type="submit">makeNode</button>
      </form>

      <div id="node">0</div>
      <div id="node">0</div>
    </div>

<div id="garden-overlay" class="dim"></div>
<div id="garden"></div>
<div id="graph"></div>

<script>
  var Graph = null
  const elem = document.getElementById('graph');
  // const garden = document.getElementById('garden');
  const garden_overlay = document.getElementById('garden-overlay');
  var selectedNode = 0
  var nextNode = 3
  var previousNode 
  var divNodes = []
  var gotBadge = false

  var renderTimer
  var focusTimer

  // states we have to animate
  var state = "ready" // one node is centered with its local area shows (1hops)
  // var state = "new" // new badge is scanned, current node is pinned left
  // var state = "connecting" // new badge garden appears & grows right unconnected to node with adjacent nodes
  // var state = "connected" // connected made and both gardens are visible for 30 sec
  // var state = "ready" // Animate to new garden, wait for next

  function zoomTo(node){
    console.log('hello')
    Graph.centerAt(node.x, node.y, 1000);
    Graph.zoom(20, 2000);
  }

  function makeNode(e) {
    e.preventDefault()
    var { nodes, links } = Graph.graphData();
    nodes.push({id: "new", group: 1 })
    Graph.graphData({ nodes, links });
    state = "ready"

    var dot = document.createElement('div');
    dot.id = Graph.graphData().nodes.length-1
    dot.className = 'dot'
    // elem.appendChild(dot);
    elem.insertAdjacentElement('afterbegin', dot)

    divNodes.push({el: dot})

    initCycle()
  }

  function focusGarden() {
    zoomTo(nextNode)
    clearTimeout(focusTimer);
    state = "focused"
    garden_overlay.className = 'none'
    initCycle()
  }

  function focusGraph() {
    // Graph.centerAt(0, 0, 1000);
    Graph.zoom(1, 2000);
    clearTimeout(focusTimer);
    state = "waiting"
    garden_overlay.className = 'dim'
    initCycle()
  }

  function renderGarden() {
    var { nodes, links } = Graph.graphData();
    if(previousNode){
      links.push({source: previousNode, target: nextNode, val: 10 })
      Graph.graphData({ nodes, links });
    }
    clearTimeout(renderTimer);
    focusTimer = setTimeout(focusGarden, 3000);
  }

  function initCycle() {
    if (state === "waiting"){
      console.log("ready for next one")
      // renderTimer = setTimeout(focusGraph, 10000);
    } else if(state === 'ready'){
      previousNode = nextNode
      nextNode = Graph.graphData().nodes[Graph.graphData().nodes.length-1]
      Graph.centerAt(nextNode.x, nextNode.y, 1000);
      renderTimer = setTimeout(renderGarden, 3000);
    } else if (state === "focused"){
      console.log("growing garden")
      renderTimer = setTimeout(focusGraph, 10000);
    }
  }

  fetch('miserables.json').then(res => res.json()).then(data => {
    function manageNodes(nodes){
      var garden = document.getElementById("garden")
      var graph = document.getElementById( 'graph' )

      var canvas = document.getElementById('graph').getElementsByTagName( 'canvas' )[0];
      var ctx = canvas.getContext('2d')
      var canvasZoom = ctx.canvas.__zoom;

      var correctedX = ((nextNode.x * canvasZoom.k) + (canvasZoom.x))
      var correctedY = ((nextNode.y * canvasZoom.k) + (canvasZoom.y))

      nodes.forEach((node, i) => {
        var el = document.getElementById(i)
        var correctedX = ((node.x * canvasZoom.k) + (canvasZoom.x))
        var correctedY = ((node.y * canvasZoom.k) + (canvasZoom.y))
        // console.log(el)
        el.style = "transform: translate(" + correctedX + "px ," + correctedY + "px);"
      })

      garden.style = "transform: translate(" + correctedX + "px ," + correctedY + "px);"
    }

    Graph = ForceGraph()(elem)
      .graphData(data)
      .nodeLabel('id')
      .nodeAutoColorBy('group')
      .linkDirectionalParticles(2)
      .linkDirectionalParticleWidth(1.4)
      .onNodeHover(node => elem.style.cursor = node ? 'pointer' : null)
      .onEngineTick(() => manageNodes(Graph.graphData().nodes))
      .enableZoomPanInteraction(false)
      .onNodeClick(node => {
        zoomTo(node)
      });
    
      nextNode = Graph.graphData().nodes[0]

      Graph.graphData().nodes.forEach((node,i) => {
        var dot = document.createElement('div');
        dot.id = i
        dot.className = 'dot'
        // elem.appendChild(dot);
        elem.insertAdjacentElement('afterbegin', dot)

        divNodes.push({el: dot})
      })
  });
</script>
</body>
